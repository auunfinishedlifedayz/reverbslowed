<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Editor - Reverb + Rain + Slowed</title>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
            position: relative;
            overflow: hidden;
        }

        .animated-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            background: linear-gradient(45deg, #000, #1a0033, #330066, #1a0033, #000);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            background: rgba(147, 51, 234, 0.3);
            border-radius: 50%;
            animation: float linear infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.5;
            }
            90% {
                opacity: 0.5;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }

        .container {
            width: 100%;
            max-width: 512px;
            position: relative;
            z-index: 10;
        }

        .card {
            background: linear-gradient(135deg, #18181b 0%, #000 100%);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 0 20px 50px rgba(147, 51, 234, 0.2);
            border: 1px solid rgba(147, 51, 234, 0.3);
        }

        h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 56px;
            font-weight: normal;
            letter-spacing: 4px;
            background: linear-gradient(to right, #c084fc, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 8px;
        }

        .subtitle {
            text-align: center;
            color: rgba(147, 51, 234, 0.7);
            font-size: 14px;
            margin-bottom: 32px;
            font-weight: 500;
        }

        .upload-area {
            margin-bottom: 32px;
        }

        .upload-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 128px;
            border: 2px dashed rgba(107, 33, 168, 0.5);
            border-radius: 16px;
            background: rgba(59, 7, 100, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-box:hover {
            background: rgba(59, 7, 100, 0.4);
        }

        .upload-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 12px;
            color: #c084fc;
        }

        .upload-text {
            font-size: 14px;
            color: #d8b4fe;
            font-weight: 500;
        }

        #fileInput {
            display: none;
        }

        .player-section {
            display: none;
            margin-bottom: 32px;
        }

        .player-card {
            background: rgba(59, 7, 100, 0.3);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(107, 33, 168, 0.4);
            margin-bottom: 32px;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .play-button {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(to right, #9333ea, #7c3aed);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(147, 51, 234, 0.5);
        }

        .play-button:hover {
            background: linear-gradient(to right, #a855f7, #8b5cf6);
        }

        .play-icon {
            width: 24px;
            height: 24px;
            color: white;
        }

        .time-display {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: #d8b4fe;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(59, 7, 100, 0.5);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #a855f7, #8b5cf6);
            width: 0%;
            transition: width 0.1s;
        }

        .control-group {
            background: rgba(59, 7, 100, 0.2);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(107, 33, 168, 0.3);
            margin-bottom: 24px;
        }

        .control-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .control-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .control-icon-box {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(107, 33, 168, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-icon {
            width: 20px;
            height: 20px;
            color: #c084fc;
        }

        .control-name {
            color: #e9d5ff;
            font-weight: 600;
        }

        .control-value {
            color: #c084fc;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            background: rgba(59, 7, 100, 0.5);
            border-radius: 9999px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #a855f7;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #a855f7;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .download-button {
            width: 100%;
            padding: 16px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 18px;
            background: linear-gradient(to right, #9333ea, #7c3aed);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(147, 51, 234, 0.5);
        }

        .download-button:hover {
            background: linear-gradient(to right, #a855f7, #8b5cf6);
        }

        .download-icon {
            width: 24px;
            height: 24px;
        }
    </style>
</head>
<body>
    <div class="animated-bg"></div>
    <div class="particles" id="particles"></div>
    
    <div class="container">
        <div class="card">
            <h1>REVERB+SLOWED</h1>
            <p class="subtitle">Dev by fearr ☠️</p>
            
            <!-- Upload Section -->
            <div class="upload-area">
                <label for="fileInput" class="upload-box" id="uploadBox">
                    <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    <p class="upload-text" id="uploadText">Cliquez pour charger un fichier MP3</p>
                </label>
                <input type="file" id="fileInput" accept="audio/mp3,audio/mpeg">
            </div>

            <!-- Player Section -->
            <div class="player-section" id="playerSection">
                <div class="player-card">
                    <div class="player-controls">
                        <button class="play-button" id="playButton">
                            <svg class="play-icon" id="playIcon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M8 5v14l11-7z"></path>
                            </svg>
                            <svg class="play-icon" id="pauseIcon" fill="currentColor" viewBox="0 0 24 24" style="display: none;">
                                <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"></path>
                            </svg>
                        </button>
                        <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="control-group">
                    <div class="control-header">
                        <div class="control-label">
                            <div class="control-icon-box">
                                <svg class="control-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path>
                                </svg>
                            </div>
                            <span class="control-name">Reverb</span>
                        </div>
                        <span class="control-value" id="reverbValue">0%</span>
                    </div>
                    <input type="range" min="0" max="100" value="0" id="reverbSlider">
                </div>

                <div class="control-group">
                    <div class="control-header">
                        <div class="control-label">
                            <div class="control-icon-box">
                                <svg class="control-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                </svg>
                            </div>
                            <span class="control-name">Vitesse</span>
                        </div>
                        <span class="control-value" id="speedValue">100%</span>
                    </div>
                    <input type="range" min="25" max="100" value="100" id="speedSlider">
                </div>

                <!-- Download Button -->
                <button class="download-button" id="downloadButton">
                    <svg class="download-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Télécharger
                </button>
            </div>
        </div>
    </div>

    <script>
        // Créer les particules animées
        const particlesContainer = document.getElementById('particles');
        for (let i = 0; i < 50; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            const size = Math.random() * 4 + 2;
            particle.style.width = size + 'px';
            particle.style.height = size + 'px';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
            particle.style.animationDelay = Math.random() * 5 + 's';
            particlesContainer.appendChild(particle);
        }

        let audioContext;
        let sourceNode;
        let audioBuffer;
        let convolver;
        let dryGain;
        let wetGain;
        let playbackRate = 1;
        let startTime = 0;
        let pauseTime = 0;
        let isPlaying = false;
        let animationFrame;

        const fileInput = document.getElementById('fileInput');
        const uploadText = document.getElementById('uploadText');
        const playerSection = document.getElementById('playerSection');
        const playButton = document.getElementById('playButton');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const timeDisplay = document.getElementById('timeDisplay');
        const progressFill = document.getElementById('progressFill');
        const reverbSlider = document.getElementById('reverbSlider');
        const speedSlider = document.getElementById('speedSlider');
        const reverbValue = document.getElementById('reverbValue');
        const speedValue = document.getElementById('speedValue');
        const downloadButton = document.getElementById('downloadButton');

        // Initialize Audio Context
        function initAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            convolver = audioContext.createConvolver();
            dryGain = audioContext.createGain();
            wetGain = audioContext.createGain();

            createImpulseResponse();

            dryGain.gain.value = 1;
            wetGain.gain.value = 0;
        }

        function createImpulseResponse() {
            const length = audioContext.sampleRate * 2;
            const impulse = audioContext.createBuffer(2, length, audioContext.sampleRate);

            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    channelData[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioContext.sampleRate * 0.5));
                }
            }

            convolver.buffer = impulse;
        }

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadText.textContent = file.name;

            if (!audioContext) {
                initAudioContext();
            }

            const arrayBuffer = await file.arrayBuffer();
            audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

            playerSection.style.display = 'block';
            updateTimeDisplay();
        });

        function startAudio() {
            if (!audioBuffer) return;

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            sourceNode = audioContext.createBufferSource();
            sourceNode.buffer = audioBuffer;
            sourceNode.playbackRate.value = playbackRate;

            sourceNode.connect(dryGain);
            dryGain.connect(audioContext.destination);

            sourceNode.connect(convolver);
            convolver.connect(wetGain);
            wetGain.connect(audioContext.destination);

            startTime = audioContext.currentTime;
            sourceNode.start(0, pauseTime);

            isPlaying = true;
            updatePlayButton();
            updateProgress();
        }

        function stopAudio() {
            if (sourceNode) {
                try {
                    sourceNode.stop();
                } catch (e) {}
                sourceNode = null;
            }

            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
            }

            const currentTime = pauseTime + (audioContext.currentTime - startTime) * playbackRate;
            pauseTime = Math.min(currentTime, audioBuffer.duration);

            isPlaying = false;
            updatePlayButton();
        }

        function togglePlayPause() {
            if (isPlaying) {
                stopAudio();
            } else {
                startAudio();
            }
        }

        function updateProgress() {
            if (isPlaying && audioContext) {
                const elapsed = (audioContext.currentTime - startTime) * playbackRate;
                const currentTime = pauseTime + elapsed;

                if (currentTime >= audioBuffer.duration) {
                    pauseTime = 0;
                    stopAudio();
                    progressFill.style.width = '0%';
                    updateTimeDisplay();
                } else {
                    const progress = (currentTime / audioBuffer.duration) * 100;
                    progressFill.style.width = progress + '%';
                    updateTimeDisplay(currentTime);
                    animationFrame = requestAnimationFrame(updateProgress);
                }
            }
        }

        function updatePlayButton() {
            if (isPlaying) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }

        function formatTime(time) {
            const mins = Math.floor(time / 60);
            const secs = Math.floor(time % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimeDisplay(current = 0) {
            const currentTime = pauseTime + current;
            const duration = audioBuffer ? audioBuffer.duration : 0;
            timeDisplay.textContent = `${formatTime(currentTime)} / ${formatTime(duration)}`;
        }

        playButton.addEventListener('click', togglePlayPause);

        reverbSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            reverbValue.textContent = value + '%';
            const wetAmount = value / 100;
            const dryAmount = 1 - (wetAmount * 0.5);

            if (wetGain && audioContext) {
                wetGain.gain.setTargetAtTime(wetAmount, audioContext.currentTime, 0.01);
                dryGain.gain.setTargetAtTime(dryAmount, audioContext.currentTime, 0.01);
            }
        });

        speedSlider.addEventListener('input', (e) => {
            const value = e.target.value;
            speedValue.textContent = value + '%';
            playbackRate = value / 100;

            if (sourceNode) {
                sourceNode.playbackRate.setTargetAtTime(playbackRate, audioContext.currentTime, 0.01);
            }
        });

        downloadButton.addEventListener('click', async () => {
            if (!audioBuffer) return;

            const offlineCtx = new OfflineAudioContext(
                2,
                audioBuffer.length,
                audioBuffer.sampleRate
            );

            const source = offlineCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.playbackRate.value = playbackRate;

            const conv = offlineCtx.createConvolver();
            conv.buffer = convolver.buffer;

            const dry = offlineCtx.createGain();
            const wet = offlineCtx.createGain();

            dry.gain.value = dryGain.gain.value;
            wet.gain.value = wetGain.gain.value;

            source.connect(dry);
            dry.connect(offlineCtx.destination);
            source.connect(conv);
            conv.connect(wet);
            wet.connect(offlineCtx.destination);

            source.start();

            const renderedBuffer = await offlineCtx.startRendering();
            const wav = bufferToWave(renderedBuffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = uploadText.textContent.replace('.mp3', '_edited.wav');
            a.click();
        });

        function bufferToWave(buffer) {
            const length = buffer.length * buffer.numberOfChannels * 2 + 44;
            const arrayBuffer = new ArrayBuffer(length);
            const view = new DataView(arrayBuffer);
            const channels = [];
            let pos = 0;

            const setUint16 = (data) => {
                view.setUint16(pos, data, true);
                pos += 2;
            };

            const setUint32 = (data) => {
                view.setUint32(pos, data, true);
                pos += 4;
            };

            setUint32(0x46464952);
            setUint32(length - 8);
            setUint32(0x45564157);
            setUint32(0x20746d66);
            setUint32(16);
            setUint16(1);
            setUint16(buffer.numberOfChannels);
            setUint32(buffer.sampleRate);
            setUint32(buffer.sampleRate * 4);
            setUint16(buffer.numberOfChannels * 2);
            setUint16(16);
            setUint32(0x61746164);
            setUint32(length - pos - 4);

            for (let i = 0; i < buffer.numberOfChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }

            let offset = 0;
            while (pos < length) {
                for (let i = 0; i < buffer.numberOfChannels; i++) {
                    let sample = Math.max(-1, Math.min(1, channels[i][offset]));
                    sample = sample < 0 ? sample * 0x8000 : sample * 0x7fff;
                    view.setInt16(pos, sample, true);
                    pos += 2;
                }
                offset++;
            }

            return arrayBuffer;
        }
    </script>
</body>
</html>